{% extends "blog/base.html"%}
{% load static %}

{%block title%} {{post.title}} {% endblock %}

{%block css_file%} 
 <link rel="stylesheet", href="{% static "blog/post-detail.css"%}">
{%endblock%}


{% block content %}
  <section id="summary">

      {% if user.is_authenticated %}
        <a href="{%url 'add-tag'%}" class="btn btn-info">Create discussion tag</a>
      {% endif %}
        <h2>{{post.title}}</h2>
        <div>
            {%for tag in tags %}
              <span class="tagged"> {{tag.caption}}</span>
            {% endfor%}
        </div>
        
        <article>
            <img src="{{post.image.url}}" alt="{{post.title}}">
            <address>By {{post.author}}</address>
            <div>Last updated on <time> {{post.date |date:"d M Y" }}</time></div>
        </article>
  </section>
    {% if user.is_authenticated %}
            <main>
          
                {%if edit_rights %}
                  <a href="{%url 'delete-post' post.slug%}" class="btn btn-danger"> Delete Post</a>
                  <a href="{{post.slug}}/edit" class="btn btn-info">Edit Post</a>
                {% else %}
                  <button class="btn btn-danger" disabled=True>Delete Post</button>
                  <a disabled=True class="btn btn-info">Edit Post</a>
                {% endif %}
          
            </main>

            <main>
                  {{post.content}}
                  <br>
                  <div class="d-flex flex-row">
                    <form method="POST" action="{% url 'likes' post.pk %}">
                      {%csrf_token%}
                      <input type="hidden" name="next" value="{{request.path}}">
                      <button style="background-color: transparent;border:none;box-shadow: none;" type="submit">
                        <i class="far fa-thumbs-up"><span>{{post.liked.all.count}}</span></i>
                      </button>
                    </form>

                    <form method="POST" action="{% url 'dislikes' post.pk %}">
                      {%csrf_token%}
                      <input type="hidden" name="next" value="{{request.path}}">
                      <button style="background-color: transparent;border:none;box-shadow: none;" type="submit">
                        <i class="far fa-thumbs-down"><span>{{post.disliked.all.count}}</span></i>
                      </button>
                    </form>
                  </div>
                  <hr>
                  {% if user.is_authenticated %}
                      {% if not comments.all %}
                          No Comments Yet.... 
                      {% else %}
                        <h2> Comments ({{total_comments}})</h2>
                            {% for comment in comments.all %}
                              {%if comment.is_parent%}
                                <strong>
                                    {{comment.commentor.username|capfirst}} -
                                    {{comment.date_added}}
                                </strong>
                                {{comment.body}}

                                <div class="d-flex flex-row">
                                  <form method="POST" action="{% url 'comment-likes' comment.pk %}">
                                    {%csrf_token%}
                                    <input type="hidden" name="next" value="{{request.path}}">
                                    <button style="background-color: transparent;border:none;box-shadow: none;" type="submit">
                                      <i class="far fa-thumbs-up"><span>{{comment.liked.all.count}}</span></i>
                                    </button>
                                  </form>
              
                                  <form method="POST" action="{% url 'comment-dislikes' comment.pk %}">
                                    {%csrf_token%}
                                    <input type="hidden" name="next" value="{{request.path}}">
                                    <button style="background-color: transparent;border:none;box-shadow: none;" type="submit">
                                      <i class="far fa-thumbs-down"><span>{{comment.disliked.all.count}}</span></i>
                                    </button>
                                  </form>
                                  {%if request.user.username == comment.commentor.username %}
                                          <a href="{% url 'delete-comment' post.pk %}"><i class=" fa fa-trash"></i></a>
                                  {% endif %} &nbsp
                                  <div>
                                    <button class="remove-default-btn"> <i class="far fa-comment-dots" onclick="commentReplyToggle('{{comment.pk}}')"></i> </button>
                                  </div>
                                  
                                </div>                                          
                                <br>

                               <!-- <div class="row mr-10 d-none" id="{{comment.pk}}"> 
                                  <div class="col-md-6">
                                    <form method="POST" enctype="multipart/form-data"> 
                                      
                                      <button type="submit" class="btn btn-light">Submit</button>
                                  </form>    
                                  </div>
                                  <div class="col-md-6"> </div>
                                    
                                </div>-->
                                <div class="row justify-content-center mt-3 mb-5 d-none" id="{{comment.pk}}">
                                  <div class="col-md-5 col-sm-12">
                                    <form method="POST">
                                      {% csrf_token %}
                                      {{formC.as_p}}
                                      <div class="d-grip gap-2">
                                        <button class="btn btn-success mt-3">Submit</button>
                                      </div>
                                    </form>
                                  </div>
                                </div>
                                <hr>
                                  {%for child_comment in comment.children%}
                                    <div class="row justify-content-center mt-3 mb-5 child-comment">
                                      <div class="col-md-5 col-sm-12 border-bottom">
                                          <p>
                                            <strong>
                                              {{child_comment.commentor.username|capfirst}} -
                                              {{child_comment.date_added}}
                                          </strong>
                                          </p>
                                          <p>{{child_comment.body}}</p>
                                          {%if request.user.username == child_comment.commentor.username %}
                                          <a href="{% url 'delete-comment' post.pk %}"><i class=" fa fa-trash"></i></a>
                                          {% endif %}
                                      </div>
                                    </div>
                                  {%endfor%}
                              {%endif%}
                            {% endfor %}   

                      {% endif %}

                  {% endif %}
                      
                  

          
              

                  <h2> Add a new comment</h2>
                  {% if user.is_authenticated %}
                    <div class="row mr-10"> 
                      <div class="col-md-6">
                        <form method="POST" enctype="multipart/form-data"> 
                          {% csrf_token %}
                          {{formC.as_p}}
                          <button type="submit" class="btn btn-light">Post</button>
                      </form>    
                      </div>
                      <div class="col-md-6"> </div>
                        
                    </div>
                  {% else %}
                      
                        <div class="col-md-6">
                          
                      </div>
                  {% endif %}
            </main>
      {%else%}
      
        <main>
          <div class="alert alert-danger" role="alert">
            To leave a comment on the discussion, please first <strong>register or login</strong> with an existing account.!
          </div>
          <p></p>
        </main>
            
      {% endif %} 
  <script type="text/javascript" src="{% static 'blog/js/social.js' %}"></script>
{% endblock %}